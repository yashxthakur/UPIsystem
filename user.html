<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - UPI System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="user-info">
                <h1 id="userName">Welcome!</h1>
                <p id="userEmail">Loading...</p>
            </div>
            <div class="wallet-balance">
                <div class="wallet-label">Wallet Balance</div>
                <div class="wallet-amount" id="walletBalance">â‚¹0.00</div>
            </div>
            <button class="btn-logout" id="logoutBtn">Sign Out</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="deposit">Deposit</button>
            <button class="tab-btn" data-tab="withdraw">Withdraw</button>
            <button class="tab-btn" data-tab="history">History</button>
        </div>

        <!-- Deposit Tab -->
        <div class="tab-content active" id="deposit-tab">
            <div class="card">
                <h2>Deposit Money</h2>
                <form id="depositForm" class="transaction-form">
                    <div class="form-group">
                        <label for="depositAmount">Amount (â‚¹)</label>
                        <input type="number" id="depositAmount" required min="1" step="0.01" placeholder="Enter amount">
                    </div>

                    <div class="qr-section">
                        <h3>Scan Admin UPI QR Code</h3>
                        <div id="qrCodeContainer">
                            <img src="QR.jpeg" alt="Admin UPI QR Code" style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                        </div>
                        <p id="adminUpiDisplay" style="margin-top: 15px; color: #3b82f6; font-weight: 600; font-size: 14px;"></p>
                    </div>

                    <button type="button" class="btn btn-secondary" id="makePaymentBtn">Make Payment</button>

                    <div class="form-group" id="utrGroup" style="display: none;">
                        <label for="utrNumber">UTR Number</label>
                        <input type="text" id="utrNumber" required placeholder="Enter UTR number from payment receipt">
                        <small class="form-hint">Enter the UTR/Transaction ID from your payment</small>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitDepositBtn" style="display: none;">Submit Deposit Request</button>
                </form>
                <div id="depositMessage" class="message"></div>
            </div>
        </div>

        <!-- Withdraw Tab -->
        <div class="tab-content" id="withdraw-tab">
            <div class="card">
                <h2>Withdraw Money</h2>
                <form id="withdrawForm" class="transaction-form">
                    <div class="form-group">
                        <label for="withdrawAmount">Amount (â‚¹)</label>
                        <input type="number" id="withdrawAmount" required min="1" step="0.01" placeholder="Enter amount">
                    </div>

                    <div class="form-group">
                        <label>Withdrawal Method</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="withdrawMethod" value="upi" checked>
                                <span>UPI</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="withdrawMethod" value="bank">
                                <span>Bank Transfer</span>
                            </label>
                        </div>
                    </div>

                    <div id="upiDetails">
                        <div class="form-group">
                            <label for="upiId">UPI ID</label>
                            <input type="text" id="upiId" placeholder="yourname@paytm / yourname@phonepe">
                        </div>
                        <div class="form-group">
                            <label for="upiName">Name (as per UPI)</label>
                            <input type="text" id="upiName" placeholder="Enter name registered with UPI">
                        </div>
                    </div>

                    <div id="bankDetails" style="display: none;">
                        <div class="form-group">
                            <label for="accountNumber">Account Number</label>
                            <input type="text" id="accountNumber" placeholder="Enter account number">
                        </div>
                        <div class="form-group">
                            <label for="ifscCode">IFSC Code</label>
                            <input type="text" id="ifscCode" placeholder="Enter IFSC code">
                        </div>
                        <div class="form-group">
                            <label for="bankName">Bank Name</label>
                            <input type="text" id="bankName" placeholder="Enter bank name">
                        </div>
                        <div class="form-group">
                            <label for="accountName">Account Holder Name</label>
                            <input type="text" id="accountName" placeholder="Enter account holder name">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Request Withdrawal</button>
                </form>
                <div id="withdrawMessage" class="message"></div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="history-tab">
            <div class="card">
                <h2>Transaction History</h2>
                <div id="historyList" class="history-list">
                    <p class="loading-text">Loading transactions...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
        import { collection, addDoc, query, where, getDocs, serverTimestamp, doc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const depositForm = document.getElementById('depositForm');
        const withdrawForm = document.getElementById('withdrawForm');
        const makePaymentBtn = document.getElementById('makePaymentBtn');
        const submitDepositBtn = document.getElementById('submitDepositBtn');
        const utrGroup = document.getElementById('utrGroup');
        const depositMessage = document.getElementById('depositMessage');
        const withdrawMessage = document.getElementById('withdrawMessage');
        const historyList = document.getElementById('historyList');
        const adminUpiDisplay = document.getElementById('adminUpiDisplay');
        const walletBalance = document.getElementById('walletBalance');

        let currentUser = null;
        let adminUpiId = null;

        // Load admin UPI ID (optional display)
        async function loadAdminUpiId() {
            try {
                const settingsRef = doc(db, 'adminSettings', 'upiId');
                
                // Use onSnapshot for real-time updates
                onSnapshot(settingsRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        adminUpiId = data.upiId;
                        
                        if (adminUpiId) {
                            adminUpiDisplay.textContent = `Admin UPI: ${adminUpiId}`;
                        } else {
                            adminUpiDisplay.textContent = 'Admin UPI ID not set';
                        }
                    } else {
                        adminUpiDisplay.textContent = 'Admin UPI ID not configured';
                    }
                }, (error) => {
                    console.error('Snapshot error:', error);
                    adminUpiDisplay.textContent = 'Error loading admin UPI ID';
                });
            } catch (error) {
                console.error('Load admin UPI error:', error);
                adminUpiDisplay.textContent = 'Error loading admin UPI ID';
            }
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
                
                if (btn.dataset.tab === 'history') {
                    loadHistory();
                }
                calculateWalletBalance();
            });
        });

        // Withdrawal method toggle
        document.querySelectorAll('input[name="withdrawMethod"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'upi') {
                    document.getElementById('upiDetails').style.display = 'block';
                    document.getElementById('bankDetails').style.display = 'none';
                } else {
                    document.getElementById('upiDetails').style.display = 'none';
                    document.getElementById('bankDetails').style.display = 'block';
                }
            });
        });

        // Make Payment button
        makePaymentBtn.addEventListener('click', () => {
            const amount = document.getElementById('depositAmount').value;
            if (!amount || amount <= 0) {
                showMessage(depositMessage, 'Please enter a valid amount', 'error');
                return;
            }
            alert(`Please make a payment of â‚¹${amount} to the admin UPI ID shown in the QR code above. After payment, you will receive a UTR number.`);
            utrGroup.style.display = 'block';
            submitDepositBtn.style.display = 'block';
            makePaymentBtn.style.display = 'none';
        });

        // Deposit form submission
        depositForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const amount = parseFloat(document.getElementById('depositAmount').value);
            const utrNumber = document.getElementById('utrNumber').value;

            if (!utrNumber) {
                showMessage(depositMessage, 'Please enter UTR number', 'error');
                return;
            }

            try {
                await addDoc(collection(db, 'deposits'), {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName || 'User',
                    amount: amount,
                    utrNumber: utrNumber,
                    status: 'pending',
                    type: 'deposit',
                    createdAt: serverTimestamp()
                });

                showMessage(depositMessage, 'Deposit request submitted successfully! Admin will verify and approve.', 'success');
                depositForm.reset();
                utrGroup.style.display = 'none';
                submitDepositBtn.style.display = 'none';
                makePaymentBtn.style.display = 'block';
            } catch (error) {
                console.error('Deposit error:', error);
                showMessage(depositMessage, 'Error submitting deposit request. Please try again.', 'error');
            }
        });

        // Withdraw form submission
        withdrawForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const method = document.querySelector('input[name="withdrawMethod"]:checked').value;

            let withdrawalData = {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                userName: currentUser.displayName || 'User',
                amount: amount,
                method: method,
                status: 'pending',
                type: 'withdraw',
                createdAt: serverTimestamp()
            };

            if (method === 'upi') {
                const upiId = document.getElementById('upiId').value;
                const upiName = document.getElementById('upiName').value;
                if (!upiId || !upiName) {
                    showMessage(withdrawMessage, 'Please fill all UPI details', 'error');
                    return;
                }
                withdrawalData.upiId = upiId;
                withdrawalData.upiName = upiName;
            } else {
                const accountNumber = document.getElementById('accountNumber').value;
                const ifscCode = document.getElementById('ifscCode').value;
                const bankName = document.getElementById('bankName').value;
                const accountName = document.getElementById('accountName').value;
                if (!accountNumber || !ifscCode || !bankName || !accountName) {
                    showMessage(withdrawMessage, 'Please fill all bank details', 'error');
                    return;
                }
                withdrawalData.accountNumber = accountNumber;
                withdrawalData.ifscCode = ifscCode;
                withdrawalData.bankName = bankName;
                withdrawalData.accountName = accountName;
            }

            try {
                await addDoc(collection(db, 'withdrawals'), {
                    ...withdrawalData
                });

                showMessage(withdrawMessage, 'Withdrawal request submitted successfully! Admin will process it soon.', 'success');
                withdrawForm.reset();
                document.getElementById('upiDetails').style.display = 'block';
                document.getElementById('bankDetails').style.display = 'none';
                setTimeout(() => calculateWalletBalance(), 500);
            } catch (error) {
                console.error('Withdraw error:', error);
                showMessage(withdrawMessage, 'Error submitting withdrawal request. Please try again.', 'error');
            }
        });

        // Calculate wallet balance
        async function calculateWalletBalance() {
            if (!currentUser) return;

            try {
                // Get all deposits and withdrawals for this user
                const depositsQuery = query(
                    collection(db, 'deposits'),
                    where('userId', '==', currentUser.uid)
                );
                const withdrawalsQuery = query(
                    collection(db, 'withdrawals'),
                    where('userId', '==', currentUser.uid)
                );

                const [depositsSnapshot, withdrawalsSnapshot] = await Promise.all([
                    getDocs(depositsQuery),
                    getDocs(withdrawalsQuery)
                ]);

                let balance = 0;

                // Add approved deposits
                depositsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'approved') {
                        balance += parseFloat(data.amount || 0);
                    }
                });

                // Subtract approved withdrawals
                withdrawalsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'approved') {
                        balance -= parseFloat(data.amount || 0);
                    }
                });

                // Update wallet display
                walletBalance.textContent = `â‚¹${balance.toFixed(2)}`;
            } catch (error) {
                console.error('Error calculating wallet balance:', error);
                walletBalance.textContent = 'â‚¹0.00';
            }
        }

        // Load transaction history
        async function loadHistory() {
            if (!currentUser) return;

            historyList.innerHTML = '<p class="loading-text">Loading transactions...</p>';

            try {
                // Query without orderBy to avoid index requirement
                const depositsQuery = query(
                    collection(db, 'deposits'),
                    where('userId', '==', currentUser.uid)
                );
                const withdrawalsQuery = query(
                    collection(db, 'withdrawals'),
                    where('userId', '==', currentUser.uid)
                );

                const [depositsSnapshot, withdrawalsSnapshot] = await Promise.all([
                    getDocs(depositsQuery),
                    getDocs(withdrawalsQuery)
                ]);

                const transactions = [];

                depositsSnapshot.forEach(doc => {
                    const data = doc.data();
                    transactions.push({
                        ...data,
                        id: doc.id,
                        date: data.createdAt?.toDate() || new Date()
                    });
                });

                withdrawalsSnapshot.forEach(doc => {
                    const data = doc.data();
                    transactions.push({
                        ...data,
                        id: doc.id,
                        date: data.createdAt?.toDate() || new Date()
                    });
                });

                // Sort by date (newest first)
                transactions.sort((a, b) => {
                    const dateA = a.date instanceof Date ? a.date : new Date(a.date);
                    const dateB = b.date instanceof Date ? b.date : new Date(b.date);
                    return dateB.getTime() - dateA.getTime();
                });

                if (transactions.length === 0) {
                    historyList.innerHTML = '<p class="empty-text">No transactions found</p>';
                    return;
                }

                historyList.innerHTML = transactions.map(txn => {
                    let additionalInfo = '';
                    if (txn.type === 'deposit' && txn.utrNumber) {
                        additionalInfo = `<p><strong>UTR:</strong> ${txn.utrNumber}</p>`;
                    } else if (txn.type === 'withdraw') {
                        if (txn.method === 'upi' && txn.upiId) {
                            additionalInfo = `<p><strong>UPI ID:</strong> ${txn.upiId}</p>`;
                        } else if (txn.method === 'bank' && txn.accountNumber) {
                            additionalInfo = `<p><strong>Account:</strong> ${txn.accountNumber} (${txn.bankName || 'N/A'})</p>`;
                        }
                    }
                    
                    return `
                        <div class="history-item ${txn.status}">
                            <div class="history-header">
                                <span class="history-type">${txn.type === 'deposit' ? 'ðŸ’° Deposit' : 'ðŸ’¸ Withdrawal'}</span>
                                <span class="history-status status-${txn.status}">${txn.status}</span>
                            </div>
                            <div class="history-body">
                                <p><strong>Amount:</strong> â‚¹${parseFloat(txn.amount || 0).toFixed(2)}</p>
                                <p><strong>Date:</strong> ${formatDate(txn.date)}</p>
                                ${additionalInfo}
                                ${txn.rejectionReason ? `<p class="rejection-reason"><strong>Rejection Reason:</strong> ${txn.rejectionReason}</p>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('History error:', error);
                historyList.innerHTML = '<p class="error-text">Error loading transactions</p>';
            }
        }

        function formatDate(date) {
            return new Intl.DateTimeFormat('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = `message ${type === 'error' ? 'error-message' : 'success-message'}`;
            setTimeout(() => {
                element.textContent = '';
                element.className = 'message';
            }, 5000);
        }

        // Auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userName.textContent = `Welcome, ${user.displayName || 'User'}!`;
                userEmail.textContent = user.email;
                loadAdminUpiId();
                calculateWalletBalance();
                
                // Update balance when transactions change
                const depositsRef = query(collection(db, 'deposits'), where('userId', '==', user.uid));
                const withdrawalsRef = query(collection(db, 'withdrawals'), where('userId', '==', user.uid));
                
                onSnapshot(depositsRef, () => calculateWalletBalance());
                onSnapshot(withdrawalsRef, () => calculateWalletBalance());
            } else {
                window.location.href = 'index.html';
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });
    </script>
</body>
</html>

